{% extends "member/base_member.html" %}

{% block title %}ç‚ºä½ æ¨è–¦çš„å…§å®¹{% endblock %}

{% block content %}

{# =========================
   1. å¡ç‰‡ Macro
   ========================= #}
{% macro card_ui(item, type) %}
<div class="recommend-card">
    <div class="img-wrapper">
        <img src="{{ item.ThumbnailURL or 'https://placehold.co/400x300?text=No+Image' }}" alt="img">
    </div>

    <div class="recommend-body">
        <div class="recommend-title">
            {% if type == 'attraction' %}{{ item.AttractionName }}
            {% elif type == 'restaurant' %}{{ item.RestaurantName }}
            {% else %}{{ item.HotelName }}{% endif %}
        </div>

        <div class="recommend-category">{{ item.RestaurantCategory or 'æ¨è–¦é …ç›®' }}</div>
        <div class="recommend-location">ğŸ“ {{ item.City or 'å°ç£' }}</div>

        <div class="recommend-actions mt-auto">
            <form method="POST" action="{{ url_for('member.add_favorite') }}">
                {% if type == 'attraction' %}
                    <input type="hidden" name="category" value="æ™¯é»">
                    <input type="hidden" name="item_id" value="{{ item.AttractionID }}">
                    <input type="hidden" name="name" value="{{ item.AttractionName }}">
                {% elif type == 'restaurant' %}
                    <input type="hidden" name="category" value="é¤å»³">
                    <input type="hidden" name="item_id" value="{{ item.RestaurantID }}">
                    <input type="hidden" name="name" value="{{ item.RestaurantName }}">
                {% else %}
                    <input type="hidden" name="category" value="ä½å®¿">
                    <input type="hidden" name="item_id" value="{{ item.HotelID }}">
                    <input type="hidden" name="name" value="{{ item.HotelName }}">
                {% endif %}

                <input type="hidden" name="image_url" value="{{ item.ThumbnailURL }}">
                <input type="hidden" name="location" value="{{ item.City or 'å°ç£' }}">

                <button type="submit" class="btn btn-outline-primary w-100">
                    ï¼‹ åŠ å…¥è¡Œç¨‹
                </button>
            </form>
        </div>
    </div>
</div>
{% endmacro %}

{# =========================
   2. CSSï¼ˆåŸæ¨£ä¿ç•™ï¼‰
   ========================= #}
<style>
.recommend-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 24px;
}
.recommend-card {
    background: #fff;
    border-radius: 14px;
    border: 1px solid #eaeaea;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    min-height: 330px;
}
.img-wrapper { height: 160px; overflow: hidden; }
.img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.recommend-body { padding: 12px 14px; display: flex; flex-direction: column; flex: 1; }
.recommend-title { font-weight: 700; min-height: 40px; }
.recommend-category { font-size: 13px; color: #ff9f6e; font-weight: 600; }
.recommend-location { font-size: 13px; color: #555; margin-bottom: 10px; }
</style>

{# =========================
   3. é é¢å…§å®¹
   ========================= #}
<div class="container">
    <h1 class="mb-2">ç‚ºä½ æ¨è–¦çš„å…§å®¹</h1>
    <p class="text-muted mb-4">æ ¹æ“šä½ çš„åå¥½è¨­å®šï¼Œæˆ‘å€‘ç‚ºä½ æº–å‚™äº†ä»¥ä¸‹ç²¾é¸é …ç›®ã€‚</p>

    <ul class="nav nav-pills mb-4">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-all">æ¨è–¦ç¸½è¦½</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-attractions">ğŸ› æ™¯é»</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-food">ğŸ¥˜ ç¾é£Ÿ</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-hotels">ğŸ¨ ä½å®¿</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-all">
            {% if attractions %}
            <h4 class="mt-4 mb-3">ğŸ ç²¾é¸æ™¯é»</h4>
            <div class="recommend-grid">
                {% for item in attractions[:3] %}{{ card_ui(item, 'attraction') }}{% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="tab-attractions">
            <div class="recommend-grid">
                {% for item in attractions %}{{ card_ui(item, 'attraction') }}{% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="tab-food">
            <div class="recommend-grid">
                {% for item in restaurants %}{{ card_ui(item, 'restaurant') }}{% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="tab-hotels">
            <div class="recommend-grid">
                {% for item in hotels %}{{ card_ui(item, 'hotel') }}{% endfor %}
            </div>
        </div>
    </div>
</div>

{# =========================
   4. AJAX + Toastï¼ˆå”¯ä¸€è¡Œç‚ºä¾†æºï¼‰
   ========================= #}
<div id="toast-container" style="position:fixed;bottom:24px;right:24px;z-index:9999;"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".recommend-actions form").forEach(form => {
    form.addEventListener("submit", e => {
      e.preventDefault();
      const btn = form.querySelector("button");
      if (btn.disabled) return;

      fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(r => r.json())
        .then(d => {
            if (d.status === "success") {
                btn.textContent = "âœ” å·²åŠ å…¥";
                btn.classList.replace("btn-outline-primary", "btn-success");
                btn.disabled = true;
                showToast("å·²åŠ å…¥æˆ‘çš„æ”¶è—è¡Œç¨‹ â¤ï¸");
            }

            if (d.status === "exists") {
                btn.textContent = "âœ” å·²åŠ å…¥";
                btn.classList.replace("btn-outline-primary", "btn-secondary");
                btn.disabled = true;
                showToast("æ­¤è¡Œç¨‹å·²åœ¨ä½ çš„æ”¶è—ä¸­");
            }
        });
    });
  });
});

function showToast(msg) {
  const t = document.createElement("div");
  t.textContent = msg;
  t.style.cssText = "background:#333;color:#fff;padding:12px 16px;border-radius:8px;margin-top:8px;opacity:0;transition:.3s";
  document.getElementById("toast-container").appendChild(t);
  requestAnimationFrame(()=>t.style.opacity=1);
  setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.remove(),300)},1800);
}
</script>

{% endblock %}