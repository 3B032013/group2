{% extends "member/base_member.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold"><i class="bi bi-calendar-event me-2"></i>{{ plan.title }}</h4>
        <div>
            <a href="{{ url_for('member.schedule') }}" class="btn btn-outline-secondary rounded-pill me-2">è¿”å›</a>
            <button id="save-all-btn" class="btn btn-primary rounded-pill px-4 shadow">
                <i class="bi bi-cloud-arrow-up me-1"></i>å„²å­˜æ‰€æœ‰æ’ç¨‹
            </button>
        </div>
    </div>

    <div class="card mb-4 border-warning shadow-sm">
        <div class="card-header bg-warning fw-bold text-dark">ğŸ“¥ å¾…åˆ†é…æ™¯é» (è«‹æ‹–æ”¾è‡³ä¸‹æ–¹æ™‚é–“æ ¼)</div>
        <div class="card-body bg-light">
            <div id="unassigned-pool" class="itinerary-sortable d-flex flex-wrap gap-2" data-day="0" style="min-height: 100px;">
                {% for detail in plan.details if detail.day_number == 0 %}
                <div class="item-card bg-white border rounded shadow-sm p-2" data-id="{{ detail.id }}" style="width: 160px; cursor: grab;">
                    <div class="handle text-center border-bottom mb-1 text-muted"><i class="bi bi-grip-horizontal"></i></div>
                    <div class="small fw-bold text-truncate">{{ detail.name }}</div>
                    <input type="hidden" class="start-time" value="09:00">
                    <input type="hidden" class="end-time" value="10:00">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        {% for i in range(1, total_days + 1) %}
        <li class="nav-item">
            <button class="nav-link {% if i == 1 %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#day-tab-{{ i }}">
                ç¬¬ {{ i }} å¤© ({{ (plan.start_date + timedelta(days=i-1)).strftime('%m/%d') }})
            </button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content bg-white border rounded shadow-sm">
        {% for i in range(1, total_days + 1) %}
        <div class="tab-pane fade {% if i == 1 %}show active{% endif %}" id="day-tab-{{ i }}">
            <div class="d-flex" style="position: relative;">
                <div style="width: 60px; flex-shrink: 0; background: #f8f9fa; border-right: 1px solid #ddd;">
                    {% for h in range(0, 24) %}
                    <div style="height: 60px; border-bottom: 1px solid #eee; font-size: 11px; text-align: center; color: #888; padding-top: 2px;">
                        {{ "%02d"|format(h) }}:00
                    </div>
                    {% endfor %}
                </div>

                <div class="itinerary-sortable main-grid" data-day="{{ i }}" style="flex-grow: 1; position: relative; min-height: 1440px;">
                    {% for h in range(0, 24) %}
                    <div style="position: absolute; top: {{ h * 60 }}px; left: 0; right: 0; height: 1px; background: #f0f0f0; pointer-events: none;"></div>
                    {% endfor %}

                    {% for detail in plan.details if detail.day_number == i %}
                        <div class="item-card position-absolute shadow-sm border-start border-4 border-primary bg-white p-2" 
                             data-id="{{ detail.id }}"
                             style="left: 10px; right: 10px; z-index: 10; border-radius: 4px;">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small handle" style="cursor: grab;">:: {{ detail.name }}</span>
                                <button class="btn btn-sm p-0 text-danger" onclick="this.closest('.item-card').remove()"><i class="bi bi-x"></i></button>
                            </div>
                            <div class="d-flex gap-1 mt-1">
                                <input type="time" class="form-control form-control-xs start-time" value="{{ detail.start_time or '09:00' }}">
                                <input type="time" class="form-control form-control-xs end-time" value="{{ detail.end_time or '10:00' }}">
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/Sortable.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("å•Ÿå‹•åŸç”Ÿ HTML5 æ‹–æ”¾ç³»çµ±...");

    // 1. åˆå§‹åŒ–å¡ç‰‡ç‚ºå¯æ‹–å‹•
    function initDraggableItems() {
        document.querySelectorAll('.item-card').forEach(card => {
            card.setAttribute('draggable', 'true');
            
            card.onscreen = null; 
            card.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', card.getAttribute('data-id'));
                card.classList.add('dragging');
                console.log("é–‹å§‹æ‹–å‹•:", card.getAttribute('data-id'));
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
            });
        });
    }

    // 2. åˆå§‹åŒ–æ”¾ç½®å®¹å™¨ (æ± å­èˆ‡ç¶²æ ¼)
    document.querySelectorAll('.itinerary-sortable').forEach(container => {
        container.addEventListener('dragover', e => {
            e.preventDefault(); // å¿…é ˆå«ç”¨ï¼Œå¦å‰‡ä¸èƒ½ drop
            container.classList.add('drag-over');
        });

        container.addEventListener('dragleave', () => {
            container.classList.remove('drag-over');
        });

        container.addEventListener('drop', e => {
            e.preventDefault();
            container.classList.remove('drag-over');
            const id = e.dataTransfer.getData('text/plain');
            const draggableElement = document.querySelector(`[data-id="${id}"]`);
            
            if (draggableElement) {
                container.appendChild(draggableElement);
                console.log(`ç§»å‹•åˆ° Day: ${container.getAttribute('data-day')}`);
                updateCardPositions(); // é‡æ–°è¨ˆç®—ä½ç½®
            }
        });
    });

    // 3. è‡ªå‹•è¨ˆç®—æ ¼å­ä½ç½® (ç¶­æŒåŸé‚è¼¯)
    function updateCardPositions() {
        document.querySelectorAll('.main-grid .item-card').forEach(card => {
            const startInput = card.querySelector('.start-time');
            const endInput = card.querySelector('.end-time');
            if (startInput && endInput) {
                const s = startInput.value.split(':');
                const e = endInput.value.split(':');
                const startMin = parseInt(s[0]) * 60 + parseInt(s[1]);
                const endMin = parseInt(e[0]) * 60 + parseInt(e[1]);
                
                card.style.position = 'absolute';
                card.style.top = startMin + 'px';
                card.style.height = Math.max(40, (endMin - startMin)) + 'px';
                card.style.width = '90%';
                card.style.left = '5%';
            }
        });

        document.querySelectorAll('#unassigned-pool .item-card').forEach(card => {
            card.style.position = 'relative';
            card.style.top = '0px';
            card.style.height = 'auto';
            card.style.width = '160px';
        });
    }

    // 4. ç›£è½æ™‚é–“è®Šå‹•èˆ‡åˆå§‹åŸ·è¡Œ
    document.addEventListener('input', e => {
        if (e.target.matches('.start-time, .end-time')) updateCardPositions();
    });

    initDraggableItems();
    updateCardPositions();
    
    // 5. å„²å­˜æŒ‰éˆ• (ç¶­æŒåŸé‚è¼¯)
    document.getElementById('save-all-btn').onclick = function() {
        const payload = [];
        document.querySelectorAll('.item-card').forEach(card => {
            const parent = card.closest('.itinerary-sortable');
            payload.push({
                id: card.getAttribute('data-id'),
                day_number: parent ? parseInt(parent.getAttribute('data-day')) : 0,
                start_time: card.querySelector('.start-time').value,
                end_time: card.querySelector('.end-time').value,
                sort_order: 0
            });
        });

        fetch('/schedule/save_all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: payload })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                alert('âœ… å„²å­˜æˆåŠŸï¼');
                window.location.reload();
            }
        });
    };
});
</script>

<style>
    .item-card { cursor: move; transition: transform 0.2s; }
    .item-card.dragging { opacity: 0.5; transform: scale(0.95); }
    .itinerary-sortable.drag-over { background-color: rgba(13, 110, 253, 0.05) !important; border: 2px dashed #0d6efd !important; }
    .main-grid { min-height: 1440px; position: relative; border: 1px solid #eee; }
    .form-control-xs { height: 24px; font-size: 11px; }
</style>
{% endblock %}