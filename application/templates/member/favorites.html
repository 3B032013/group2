{% extends "member/base_member.html" %}

{% block title %}æˆ‘çš„æ”¶è—è¡Œç¨‹{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<div class="container-fluid px-4">

    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h2 class="fw-bold" style="color: #2c3e50;">
            <i class="bi bi-heart-fill text-danger me-2"></i>æˆ‘çš„æ”¶è—è¡Œç¨‹
        </h2>
    </div>

    <!-- åˆ†é¡ Tabs -->
    <ul class="nav nav-pills mb-4">
        {% set nav_items = [
            ('all', 'å…¨éƒ¨', counts.all),
            ('attractions', 'ğŸ¡ æ™¯é»', counts.attractions),
            ('events', 'ğŸ“… æ´»å‹•', counts.events),
            ('hotels', 'ğŸ›ï¸ ä½å®¿', counts.hotels),
            ('restaurants', 'ğŸ½ï¸ é¤å»³', counts.restaurants)
        ] %}

        {% for cat_id, cat_name, cat_count in nav_items %}
        <li class="nav-item me-2">
            <a href="{{ url_for('member.favorites', category=cat_id) }}"
               class="nav-link rounded-pill px-3 fw-bold {% if current_category == cat_id %}active{% endif %}">
                {{ cat_name }}
                <span class="badge {% if current_category == cat_id %}bg-white text-primary{% else %}bg-light text-dark{% endif %} ms-1">
                    {{ cat_count }}
                </span>
            </a>
        </li>
        {% endfor %}
    </ul>

    {% if favorites %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3 pb-4">

        {% for fav in favorites %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 position-relative" style="border-radius: 12px; overflow: hidden;">

                <!-- åœ–ç‰‡ -->
                <div class="position-relative" style="height: 160px; background-color: #eee;">
                    <img src="{{ fav.image_url }}" class="card-img-top" alt="{{ fav.name }}"
                         style="width: 100%; height: 100%; object-fit: cover;">

                    <div class="position-absolute top-0 start-0 m-2">
                        <span class="badge bg-dark bg-opacity-75 rounded-pill px-2 py-1">
                            {{ fav.category }}
                        </span>
                    </div>

                    <!-- å–æ¶ˆæ”¶è— -->
                    <div class="position-absolute top-0 end-0 m-2">
                        <form action="{{ url_for('member.remove_favorite', fav_id=fav.id) }}"
                              method="POST"
                              onsubmit="return confirm('ç¢ºå®šè¦ç§»é™¤ã€Œ{{ fav.name }}ã€å—ï¼Ÿ');">
                            <button type="submit"
                                    class="btn btn-light rounded-circle text-danger"
                                    style="width: 32px; height: 32px;">
                                <i class="bi bi-heart-fill"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- å…§å®¹ -->
                <div class="card-body d-flex flex-column p-3">

                    <div class="mb-1 text-muted small">
                        <i class="bi bi-geo-alt-fill me-1 text-primary"></i>
                        {{ fav.location or 'å°ç£' }}
                    </div>

                    <h6 class="fw-bold mb-2" style="min-height: 2.6em;">
                        {{ fav.name }}
                    </h6>

                    <!-- â­ åŠ å…¥è¡Œç¨‹æ’ç¨‹ -->
                    <form method="POST"
                          action="{{ url_for('member.add_from_favorite', fav_id=fav.id) }}"
                          class="mt-auto">

                        <div class="input-group input-group-sm mb-2">
                            <select name="itinerary_id" class="form-select" required>
                                <option value="" disabled selected>
                                    åŠ å…¥åˆ°è¡Œç¨‹â€¦
                                </option>
                                {% for plan in itineraries %}
                                <option value="{{ plan.id }}">
                                    {{ plan.title }}
                                </option>
                                {% endfor %}
                            </select>

                            <button type="submit" class="btn btn-outline-success fw-bold">
                                åŠ å…¥
                            </button>
                        </div>
                    </form>

                    <!-- åº•éƒ¨è³‡è¨Š -->
                    <div class="border-top pt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {{ fav.created_at.strftime('%Y/%m/%d') }}
                        </small>

                        <button type="button"
                                class="btn btn-outline-primary btn-sm rounded-pill"
                                data-bs-toggle="modal"
                                data-bs-target="#detailModal"
                                data-title="{{ fav.name }}"
                                data-location="{{ fav.location }}"
                                data-category="{{ fav.category }}"
                                data-img="{{ fav.image_url }}"
                                data-date="{{ fav.created_at.strftime('%Y/%m/%d') }}"
                                onclick="loadModalData(this)">
                            æª¢è¦–è©³ç´°
                        </button>
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <div class="text-center py-5 mt-5">
        <h5 class="text-muted fw-bold">ç›®å‰æ²’æœ‰æ”¶è—</h5>
    </div>
    {% endif %}
</div>

<!-- è©³ç´° Modalï¼ˆåŸæœ¬ ê·¸ëŒ€ë¡œä¿ç•™ï¼‰ -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">

            <div style="height: 300px;">
                <img id="modalImg" class="w-100 h-100" style="object-fit: cover;">
            </div>

            <div class="modal-body p-4">
                <h3 id="modalTitle" class="fw-bold mb-2"></h3>
                <div class="text-muted mb-3">
                    <i class="bi bi-geo-alt-fill me-1"></i>
                    <span id="modalLocation"></span>
                </div>

                <p class="text-secondary">
                    é€™æ˜¯æ‚¨æ”¶è—çš„é …ç›®ï¼Œå¯åŠ å…¥è‡³ä»»ä¸€è¡Œç¨‹é€²è¡Œæ’ç¨‹ã€‚
                </p>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function loadModalData(btn) {
    document.getElementById('modalTitle').textContent = btn.dataset.title;
    document.getElementById('modalLocation').textContent = btn.dataset.location || 'å°ç£';
    document.getElementById('modalImg').src = btn.dataset.img;
}
</script>

{% endblock %}