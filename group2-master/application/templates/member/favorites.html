{% extends "member/base_member.html" %}

{% block title %}æˆ‘çš„æ”¶è—è¡Œç¨‹{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<div class="container-fluid px-4">
    
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h2 class="fw-bold" style="color: #2c3e50;">
            <i class="bi bi-heart-fill text-danger me-2"></i>æˆ‘çš„æ”¶è—è¡Œç¨‹
        </h2>
    </div>

    <ul class="nav nav-pills mb-4">
        {% set nav_items = [
            ('all', 'å…¨éƒ¨', counts.all),
            ('attractions', 'ğŸ¡ æ™¯é»', counts.attractions),
            ('events', 'ğŸ“… æ´»å‹•', counts.events),
            ('hotels', 'ğŸ›ï¸ ä½å®¿', counts.hotels),
            ('restaurants', 'ğŸ½ï¸ é¤å»³', counts.restaurants)
        ] %}
        
        {% for cat_id, cat_name, cat_count in nav_items %}
        <li class="nav-item me-2">
            <a href="{{ url_for('member.favorites', category=cat_id) }}" 
               class="nav-link rounded-pill px-3 fw-bold {% if current_category == cat_id %}active{% endif %}"
               style="transition: all 0.2s;">
                {{ cat_name }} 
                <span class="badge {% if current_category == cat_id %}bg-white text-primary{% else %}bg-light text-dark{% endif %} ms-1">
                    {{ cat_count }}
                </span>
            </a>
        </li>
        {% endfor %}
    </ul>

    {% if favorites %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3 pb-4">
        {% for fav in favorites %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 position-relative" style="border-radius: 12px; overflow: hidden; transition: all 0.3s ease;">
                
                <div class="position-relative" style="height: 160px; background-color: #eee;">
                    <img src="{{ fav.image_url }}" class="card-img-top" alt="{{ fav.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                    
                    <div class="position-absolute top-0 start-0 m-2">
                        <span class="badge bg-dark bg-opacity-75 backdrop-blur rounded-pill shadow-sm px-2 py-1" style="font-size: 0.75rem;">
                            {{ fav.category }}
                        </span>
                    </div>

                    <div class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                        <form action="{{ url_for('member.remove_favorite', fav_id=fav.id) }}" method="POST" onsubmit="return confirm('ç¢ºå®šè¦ç§»é™¤ã€Œ{{ fav.name }}ã€å—ï¼Ÿ');">
                            <button type="submit" class="btn btn-light rounded-circle shadow-sm d-flex align-items-center justify-content-center text-danger p-0" 
                                    style="width: 32px; height: 32px; border: none; opacity: 0.9;" title="å–æ¶ˆæ”¶è—">
                                <i class="bi bi-heart-fill" style="font-size: 1rem;"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card-body d-flex flex-column p-3">
                    <div class="mb-1 d-flex align-items-center text-muted" style="font-size: 0.8rem;">
                        <i class="bi bi-geo-alt-fill me-1 text-primary"></i>
                        <span class="fw-bold text-truncate">{{ fav.location or 'å°ç£' }}</span>
                    </div>
                    
                    <h6 class="card-title fw-bold text-dark mb-2" style="font-size: 1rem; line-height: 1.4; height: 2.8rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        {{ fav.name }}
                    </h6>
                    
                    <div class="mt-auto pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted" style="font-size: 0.75rem;">
                                {{ fav.created_at.strftime('%Y/%m/%d') }}
                            </small>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold" 
                                    style="font-size: 0.8rem;"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#detailModal"
                                    data-title="{{ fav.name }}"
                                    data-location="{{ fav.location }}"
                                    data-category="{{ fav.category }}"
                                    data-img="{{ fav.image_url }}"
                                    data-date="{{ fav.created_at.strftime('%Y/%m/%d') }}"
                                    onclick="loadModalData(this)">
                                æª¢è¦–è©³ç´°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4 pb-5">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link rounded-circle mx-1 d-flex align-items-center justify-content-center" 
                   style="width: 36px; height: 36px;"
                   href="{{ url_for('member.favorites', page=pagination.prev_num, category=current_category) if pagination.has_prev else '#' }}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>

            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link rounded-circle mx-1 d-flex align-items-center justify-content-center" 
                           style="width: 36px; height: 36px;"
                           href="{{ url_for('member.favorites', page=page_num, category=current_category) }}">
                            {{ page_num }}
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link border-0">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link rounded-circle mx-1 d-flex align-items-center justify-content-center" 
                   style="width: 36px; height: 36px;"
                   href="{{ url_for('member.favorites', page=pagination.next_num, category=current_category) if pagination.has_next else '#' }}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5 mt-5">
        <div class="bg-light rounded-circle d-inline-flex justify-content-center align-items-center mb-4" style="width: 100px; height: 100px;">
            <i class="bi bi-bookmark-heart text-secondary" style="font-size: 3rem;"></i>
        </div>
        <h5 class="text-muted fw-bold mb-2">æ­¤åˆ†é¡ç›®å‰æ²’æœ‰æ”¶è—</h5>
        <a href="/dashboard/planner" class="btn btn-primary px-4 py-2 rounded-pill shadow-sm mt-3">
            <i class="bi bi-search me-2"></i>å»é€›é€›
        </a>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            
            <div class="position-relative" style="height: 300px;">
                <img id="modalImg" src="" class="w-100 h-100" style="object-fit: cover;">
                <div class="position-absolute top-0 end-0 m-3">
                    <button type="button" class="btn-close btn-close-white bg-dark p-2 rounded-circle" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="position-absolute bottom-0 start-0 m-4">
                    <span id="modalCategory" class="badge fs-6 px-3 py-2 shadow-sm" style="background-color: #FFA97F;"></span>
                </div>
            </div>

            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-lg-7">
                        <h3 id="modalTitle" class="fw-bold mb-3" style="color: #2c3e50;"></h3>
                        <div class="mb-4 text-muted">
                            <i class="bi bi-geo-alt-fill text-danger me-2"></i><span id="modalLocation"></span>
                        </div>
                        
                        <h6 class="fw-bold border-bottom pb-2 mb-3">ğŸ“ æ™¯é»ç°¡ä»‹</h6>
                        <p class="text-secondary" style="line-height: 1.8;">
                            é€™æ˜¯æ‚¨æ”¶è—çš„ç²¾é¸è¡Œç¨‹ã€‚æ‚¨å¯ä»¥é»æ“Šä¸‹æ–¹çš„æŒ‰éˆ•åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹ç¢ºåˆ‡ä½ç½®ï¼Œæˆ–æ˜¯å›åˆ°è¡Œç¨‹è¦åŠƒé é¢æŸ¥çœ‹æ›´å¤šé¡ä¼¼çš„æ™¯é»ã€‚
                        </p>
                    </div>

                    <div class="col-lg-5">
                        <div class="card bg-light border-0 p-3" style="border-radius: 15px;">
                            <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>æ”¶è—è³‡è¨Š</h6>
                            <div class="small mb-2">
                                <span class="text-muted">æ”¶è—æ—¥æœŸï¼š</span>
                                <span id="modalDate" class="fw-bold"></span>
                            </div>
                            <div class="small mb-4">
                                <span class="text-muted">è¡Œç¨‹é¡åˆ¥ï¼š</span>
                                <span id="modalCategoryDesc" class="fw-bold"></span>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <a href="#" id="modalMapLink" target="_blank" class="btn btn-primary fw-bold rounded-pill">
                                    <i class="bi bi-map me-2"></i>Google åœ°åœ–å°èˆª
                                </a>
                                <button type="button" class="btn btn-outline-secondary fw-bold rounded-pill" data-bs-dismiss="modal">
                                    é—œé–‰è¦–çª—
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadModalData(button) {
        // å–å¾—æŒ‰éˆ•å‚³éä¾†çš„å±¬æ€§
        var title = button.getAttribute('data-title');
        var location = button.getAttribute('data-location');
        var category = button.getAttribute('data-category');
        var img = button.getAttribute('data-img');
        var date = button.getAttribute('data-date');

        // å¡«å…¥ Modal å…§å®¹
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalLocation').textContent = location || 'å°ç£';
        document.getElementById('modalCategory').textContent = category;
        document.getElementById('modalCategoryDesc').textContent = category;
        document.getElementById('modalImg').src = img;
        document.getElementById('modalDate').textContent = date;

        // è¨­å®š Google Map é€£çµ (åç¨± + åœ°é» æœå°‹æœ€æº–)
        var searchQuery = encodeURIComponent(title + " " + (location || ''));
        document.getElementById('modalMapLink').href = "https://www.google.com/maps/search/?api=1&query=" + searchQuery;

        // æ ¹æ“šé¡åˆ¥èª¿æ•´ Badge é¡è‰² (é¸åšï¼Œå¢åŠ è¦–è¦ºè±å¯Œåº¦)
        var badge = document.getElementById('modalCategory');
        if (category === 'æ™¯é»') badge.className = "badge bg-info fs-6 px-3 py-2 shadow-sm";
        else if (category === 'é¤å»³') badge.className = "badge bg-success fs-6 px-3 py-2 shadow-sm";
        else if (category === 'ä½å®¿') badge.className = "badge bg-warning text-dark fs-6 px-3 py-2 shadow-sm";
        else if (category === 'æ´»å‹•') badge.className = "badge bg-primary fs-6 px-3 py-2 shadow-sm";
    }
</script>

<style>
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .backdrop-blur {
        backdrop-filter: blur(4px);
    }
    .page-link {
        color: #2c3e50;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .page-item.active .page-link {
        background-color: #FFA97F;
        border-color: #FFA97F;
        color: white;
    }
    .nav-pills .nav-link {
        color: #555;
        background-color: #fff;
        border: 1px solid #eee;
    }
    .nav-pills .nav-link:hover {
        background-color: #f8f9fa;
    }
    .nav-pills .nav-link.active {
        background-color: #FFA97F;
        color: white;
        border-color: #FFA97F;
    }
</style>
{% endblock %}